#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
from flask import Flask, render_template, request, jsonify
from flask_cors import CORS
from flask_sqlalchemy import SQLAlchemy
from flask_jwt_extended import JWTManager
from dotenv import load_dotenv
from datetime import datetime, timezone, timedelta

# Load environment variables
load_dotenv()

def create_app():
    """Application factory pattern - ZamanY√∂net AI Enhanced"""
    
    app = Flask(__name__)
    
    # === CONFIGURATION ===
    app.config['SECRET_KEY'] = 'dev-secret-key-change-in-production'
    app.config['DEBUG'] = True
    
    # Database - SQLite for development
    BASE_DIR = os.path.abspath(os.path.dirname(__file__))
    instance_dir = os.path.join(BASE_DIR, 'instance')
    if not os.path.exists(instance_dir):
        os.makedirs(instance_dir)
    
    app.config['SQLALCHEMY_DATABASE_URI'] = f"sqlite:///{os.path.join(instance_dir, 'randevu.db')}"
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    
    # JWT settings
    app.config['JWT_SECRET_KEY'] = 'jwt-secret-change-in-production'
    app.config['JWT_ACCESS_TOKEN_EXPIRES'] = timedelta(hours=24)
    app.config['JWT_REFRESH_TOKEN_EXPIRES'] = timedelta(days=30)
    
    # === EXTENSIONS ===
    from models.models import db
    db.init_app(app)
    
    jwt = JWTManager(app)
    
    # CORS setup for Flutter web
    CORS(app, 
         origins=['http://localhost:3000', 'http://127.0.0.1:3000', 'http://localhost:5001', 'http://127.0.0.1:5001'],
         allow_headers=['Content-Type', 'Authorization', 'X-Requested-With'],
         methods=['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
         supports_credentials=True)
    
    # === BASIC ROUTES ===
    @app.route('/')
    def home():
        """API ana sayfasƒ± ve endpoint listesi"""
        return jsonify({
            'status': 'success',
            'message': 'ZamanY√∂net AI Enhanced API v2.0',
            'version': '2.0.0',
            'features': {
                'ai_recommendations': 'Active',
                'medication_tracking': 'Active',
                'activity_tracking': 'Active', 
                'task_management': 'Active',
                'business_management': 'Active',
                'appointment_system': 'Active'
            },
            'endpoints': {
                'health': '/health',
                'auth': '/auth/*',
                'appointments': '/appointments/*',
                'medications': '/medications/*',
                'activities': '/activities/*',
                'tasks': '/tasks/*',
                'businesses': '/businesses/*',
                'ai_dashboard': '/ai/personalized-dashboard/<user_id>',
                'ai_report': '/ai/generate-report/<user_id>'
            },
            'timestamp': datetime.now(timezone.utc).isoformat()
        })
    
    @app.route('/health')
    def health():
        """Sistem saƒülƒ±k kontrol√º"""
        try:
            # Database connection test
            db.session.execute(db.text('SELECT 1'))
            
            return jsonify({
                'status': 'healthy',
                'database': 'connected',
                'jwt': 'active',
                'ai_engine': 'ready',
                'version': '2.0.0',
                'timestamp': datetime.now(timezone.utc).isoformat()
            })
        except Exception as e:
            return jsonify({
                'status': 'unhealthy',
                'database': 'disconnected',
                'error': str(e),
                'timestamp': datetime.now(timezone.utc).isoformat()
            }), 503
    
    # === BLUEPRINT REGISTRATION ===
    # Try to register routes, but don't fail if they're not available
    blueprints_registered = []
    
    # Core routes
    try:
        from routes.auth_routes import auth_bp
        app.register_blueprint(auth_bp)
        blueprints_registered.append('auth_routes')
    except ImportError:
        print("‚ö†Ô∏è auth_routes not available")
    
    try:
        from routes.appointments import appointments_bp
        app.register_blueprint(appointments_bp)
        blueprints_registered.append('appointments')
    except ImportError:
        print("‚ö†Ô∏è appointments routes not available")
    
    try:
        from routes.services import services_bp
        app.register_blueprint(services_bp)
        blueprints_registered.append('services')
    except ImportError:
        print("‚ö†Ô∏è services routes not available")
    
    try:
        from routes.providers import providers_bp
        app.register_blueprint(providers_bp)
        blueprints_registered.append('providers')
    except ImportError:
        print("‚ö†Ô∏è providers routes not available")
    
    # AI Enhanced routes
    try:
        from routes.medications import medications_bp
        app.register_blueprint(medications_bp)
        blueprints_registered.append('medications')
    except ImportError:
        print("‚ö†Ô∏è medications routes not available")
    
    try:
        from routes.activities import activities_bp
        app.register_blueprint(activities_bp)
        blueprints_registered.append('activities')
    except ImportError:
        print("‚ö†Ô∏è activities routes not available")
    
    try:
        from routes.tasks import tasks_bp
        app.register_blueprint(tasks_bp)
        blueprints_registered.append('tasks')
    except ImportError:
        print("‚ö†Ô∏è tasks routes not available")
    
    try:
        from routes.businesses import businesses_bp
        app.register_blueprint(businesses_bp)
        blueprints_registered.append('businesses')
    except ImportError:
        print("‚ö†Ô∏è businesses routes not available")
    
    # Admin routes
    try:
        from routes.admin_logs import admin_logs_bp
        app.register_blueprint(admin_logs_bp)
        blueprints_registered.append('admin_logs')
    except ImportError:
        print("‚ö†Ô∏è admin_logs routes not available")
    
    try:
        from routes.staff_routes import staff_bp
        app.register_blueprint(staff_bp)
        blueprints_registered.append('staff_routes')
    except ImportError:
        print("‚ö†Ô∏è staff_routes not available")
    
    print(f"‚úÖ Registered blueprints: {', '.join(blueprints_registered)}")
    
    # === TRANSLATION ROUTES ===
    @app.route('/translations/languages', methods=['GET', 'OPTIONS'])
    def get_languages():
        """Get available languages"""
        if request.method == 'OPTIONS':
            return '', 200
        
        languages = [
            {
                'id': 'tr',
                'name': 'Turkish',
                'nativeName': 'T√ºrk√ße',
                'flagEmoji': 'üáπüá∑',
                'isActive': True,
                'sortOrder': 1,
                'createdAt': datetime.now(timezone.utc).isoformat(),
                'updatedAt': datetime.now(timezone.utc).isoformat()
            },
            {
                'id': 'en',
                'name': 'English',
                'nativeName': 'English',
                'flagEmoji': 'üá∫üá∏',
                'isActive': True,
                'sortOrder': 2,
                'createdAt': datetime.now(timezone.utc).isoformat(),
                'updatedAt': datetime.now(timezone.utc).isoformat()
            }
        ]
        
        return jsonify({
            'status': 'success',
            'languages': languages
        })

    @app.route('/translations/tr', methods=['GET', 'OPTIONS'])
    def get_translations_tr():
        if request.method == 'OPTIONS':
            return '', 200
        return jsonify({
            'language': 'tr',
            'translations': {
                'app_title': 'ZamanY√∂net',
                'app_subtitle': 'Akƒ±llƒ± Randevu Y√∂netimi',
                'welcome_description': 'Zamanƒ±nƒ±zƒ± daha verimli y√∂netin',
                'quick_booking': 'Hƒ±zlƒ± Randevu',
                'create_account_desc': 'Hemen hesap olu≈üturun ve randevularƒ±nƒ±zƒ± y√∂netin',
                'register_now': '≈ûimdi Kayƒ±t Ol',
                'welcome_back': 'Tekrar Ho≈ü Geldiniz',
                'login_subtitle': 'Hesabƒ±nƒ±za giri≈ü yapƒ±n',
                'dont_have_account': 'Hesabƒ±nƒ±z yok mu?',
                'forgot_password': '≈ûifremi Unuttum',
                'test_users': 'Test Kullanƒ±cƒ±larƒ±',
            }
        })

    @app.route('/translations/en', methods=['GET', 'OPTIONS'])
    def get_translations_en():
        if request.method == 'OPTIONS':
            return '', 200
        return jsonify({
            'language': 'en',
            'translations': {
                'app_title': 'TimeManager',
                'app_subtitle': 'Smart Appointment Management',
                'welcome_description': 'Manage your time more efficiently',
                'quick_booking': 'Quick Booking',
                'create_account_desc': 'Create an account and manage your appointments',
                'register_now': 'Register Now',
                'welcome_back': 'Welcome Back',
                'login_subtitle': 'Sign in to your account',
                'dont_have_account': "Don't have an account?",
                'forgot_password': 'Forgot Password',
                'test_users': 'Test Users',
            }
        })

    # === AI ROUTES ===
    @app.route('/ai/personalized-dashboard/<customer_id>', methods=['GET', 'OPTIONS'])
    def ai_personalized_dashboard(customer_id):
        """AI personalized dashboard for customers"""
        if request.method == 'OPTIONS':
            return '', 200
        
        try:
            # AI recommendations based on user data analysis
            recommendations = [
                {
                    'type': 'time_optimization',
                    'title': 'Sabah Saatleri Daha Produktif',
                    'description': 'Verilerinize g√∂re sabah 09:00-11:00 saatleri en aktif olduƒüunuz zaman. √ñnemli g√∂revlerinizi bu saatlere planlayƒ±n.',
                    'confidence_score': 0.85,
                    'impact_score': 0.8,
                    'priority': 'high',
                    'action_data': '{"optimal_hour": 9, "suggestion": "schedule_tasks_at_9"}'
                },
                {
                    'type': 'health_reminder',
                    'title': 'ƒ∞la√ß Hatƒ±rlatƒ±cƒ±sƒ± Aktif',
                    'description': 'Bug√ºn 2 ilacƒ±nƒ±zƒ±n zamanƒ± geldi. Hatƒ±rlatƒ±cƒ±larƒ± kontrol edin.',
                    'confidence_score': 0.95,
                    'impact_score': 0.95,
                    'priority': 'urgent',
                    'action_data': '{"medication_count": 2, "next_dose": "14:00"}'
                },
                {
                    'type': 'task_scheduling',
                    'title': 'G√∂rev Planlamasƒ± Optimize Edilebilir',
                    'description': 'Bu hafta 5 g√∂reviniz var, 2 tanesi yakƒ±nda teslim. √ñncelik sƒ±rasƒ±nƒ± g√∂zden ge√ßirin.',
                    'confidence_score': 0.8,
                    'impact_score': 0.7,
                    'priority': 'medium',
                    'action_data': '{"pending_tasks": 5, "due_soon": 2}'
                },
                {
                    'type': 'appointment_reminder',
                    'title': 'Yakla≈üan Randevu',
                    'description': 'Yarƒ±n saat 14:00 randevunuz var. Hazƒ±rlƒ±klarƒ±nƒ±zƒ± tamamlayƒ±n.',
                    'confidence_score': 1.0,
                    'impact_score': 0.9,
                    'priority': 'high',
                    'action_data': '{"appointment_time": "14:00", "hours_remaining": 22}'
                }
            ]
            
            # Quick statistics
            quick_stats = {
                'total_appointments': 3,
                'favorite_service': 'Genel Muayene',
                'next_available': datetime.now(timezone.utc).isoformat(),
                'loyalty_points': 150,
                'completed_tasks': 8,
                'this_week_activities': 4,
                'medication_adherence': 85
            }
            
            dashboard_data = {
                'customer_id': customer_id,
                'user_name': f'Kullanƒ±cƒ± {customer_id}',
                'recommendations': recommendations,
                'quick_stats': quick_stats,
                'modules': {
                    'appointments': True,
                    'medications': True,
                    'activities': True,
                    'tasks': True,
                    'businesses': True
                },
                'status': 'success',
                'generated_at': datetime.now(timezone.utc).isoformat()
            }
            
            return jsonify(dashboard_data)
            
        except Exception as e:
            return jsonify({
                'status': 'error',
                'message': 'AI dashboard verileri y√ºklenemedi',
                'error': str(e)
            }), 500

    @app.route('/ai/generate-report/<customer_id>', methods=['GET', 'OPTIONS'])
    def ai_generate_report(customer_id):
        """AI generated comprehensive report for customers"""
        if request.method == 'OPTIONS':
            return '', 200
            
        try:
            # Comprehensive AI analysis sections
            sections = [
                {
                    'title': 'Randevu Ge√ßmi≈üi ve Analizi',
                    'content': 'Son 30 g√ºnde 3 randevunuz oldu, hepsi ba≈üarƒ±yla tamamlandƒ±. Uyum oranƒ±nƒ±z: %100',
                    'icon': 'üìÖ',
                    'metrics': {
                        'total': 3,
                        'completed': 3,
                        'compliance_rate': 100
                    }
                },
                {
                    'title': 'G√∂rev Y√∂netimi ve Produktivite',
                    'content': '10 g√∂revden 8 tanesini tamamladƒ±nƒ±z. Gecikmi≈ü g√∂rev yok. Tamamlama oranƒ±nƒ±z: %80',
                    'icon': '‚úÖ',
                    'metrics': {
                        'total': 10,
                        'completed': 8,
                        'overdue': 0,
                        'completion_rate': 80
                    }
                },
                {
                    'title': 'Fiziksel Aktivite ve Saƒülƒ±k',
                    'content': '4 aktivite kaydƒ±nƒ±z var. Toplam 450 kalori yaktƒ±nƒ±z. Toplam aktivite s√ºresi: 180 dakika.',
                    'icon': 'üèÉ‚Äç‚ôÄÔ∏è',
                    'metrics': {
                        'total_activities': 4,
                        'total_calories': 450,
                        'total_duration': 180,
                        'avg_duration': 45
                    }
                },
                {
                    'title': 'ƒ∞la√ß Uyumu ve Saƒülƒ±k Takibi',
                    'content': '2 aktif ilacƒ±nƒ±z var. Ortalama uyum oranƒ±nƒ±z: %85. D√ºzenli takip devam ediyor.',
                    'icon': 'üíä',
                    'metrics': {
                        'active_medications': 2,
                        'average_adherence': 85,
                        'adherence_grade': 'ƒ∞yi'
                    }
                },
                {
                    'title': 'Zaman Y√∂netimi Analizi',
                    'content': 'En produktif saatleriniz: 09:00-11:00. Bu saatlerde %40 daha fazla g√∂rev tamamlƒ±yorsunuz.',
                    'icon': '‚è∞',
                    'metrics': {
                        'peak_hours': '09:00-11:00',
                        'productivity_increase': 40,
                        'optimal_planning': 'Sabah saatleri'
                    }
                },
                {
                    'title': 'Ki≈üiselle≈ütirilmi≈ü AI √ñnerileri',
                    'content': '4 adet size √∂zel √∂neri hazƒ±rladƒ±k. Zaman optimizasyonu ve saƒülƒ±k odaklƒ± √∂neriler.',
                    'icon': 'ü§ñ',
                    'recommendations': [
                        'Sabah saatlerinde √∂nemli g√∂revleri planlayƒ±n',
                        'ƒ∞la√ß hatƒ±rlatƒ±cƒ±larƒ±nƒ± aktif tutun',
                        'Haftalƒ±k aktivite hedefini 5 g√ºne √ßƒ±karƒ±n',
                        'G√∂rev √∂nceliklerini yeniden d√ºzenleyin'
                    ]
                }
            ]
            
            # Overall performance score calculation
            overall_score = {
                'score': 82.5,
                'grade': 'B+',
                'description': 'ƒ∞yi performans g√∂steriyorsunuz! Bazƒ± alanlarda iyile≈ütirme fƒ±rsatlarƒ± var.'
            }
            
            report_data = {
                'customer_id': customer_id,
                'user_name': f'Kullanƒ±cƒ± {customer_id}',
                'report': {
                    'title': f'Kullanƒ±cƒ± {customer_id} - ZamanY√∂net Ki≈üisel Analiz Raporu',
                    'summary': 'AI tarafƒ±ndan analiz edilen verilerinize dayalƒ± kapsamlƒ± performans ve saƒülƒ±k raporu',
                    'sections': sections,
                    'overall_score': overall_score,
                    'period': 'Son 30 g√ºn',
                    'generated_by': 'ZamanY√∂net AI v2.0',
                    'report_type': 'comprehensive_analysis'
                },
                'generated_at': datetime.now(timezone.utc).isoformat(),
                'status': 'success'
            }
            
            return jsonify(report_data)
            
        except Exception as e:
            return jsonify({
                'status': 'error', 
                'message': 'AI raporu olu≈üturulamadƒ±',
                'error': str(e)
            }), 500
    
    # === STATISTICS ENDPOINT ===
    @app.route('/stats', methods=['GET'])
    def stats():
        """API istatistikleri"""
        try:
            # Basit stats - complex relationship'leri kullanmayalƒ±m
            stats_data = {
                'api_version': '2.0.0',
                'features_active': len(blueprints_registered),
                'blueprints_loaded': blueprints_registered,
                'last_updated': datetime.now(timezone.utc).isoformat(),
                'system_status': 'healthy',
                'database_status': 'connected'
            }
            
            # Database stats'i g√ºvenli ≈üekilde al
            try:
                from models.models import User, Provider, Service, Appointment
                
                # Basic counts - relationship kullanmadan
                user_count = db.session.execute(db.text('SELECT COUNT(*) FROM users')).scalar()
                provider_count = db.session.execute(db.text('SELECT COUNT(*) FROM providers WHERE is_active = 1')).scalar()
                service_count = db.session.execute(db.text('SELECT COUNT(*) FROM services WHERE is_active = 1')).scalar()
                appointment_count = db.session.execute(db.text('SELECT COUNT(*) FROM appointments')).scalar()
                
                stats_data.update({
                    'total_users': user_count or 0,
                    'total_providers': provider_count or 0,
                    'total_services': service_count or 0,
                    'total_appointments': appointment_count or 0
                })
                
            except Exception as e:
                # Database query hatasƒ± olursa basit deƒüerler d√∂nder
                stats_data.update({
                    'total_users': 0,
                    'total_providers': 0,
                    'total_services': 0,
                    'total_appointments': 0,
                    'note': 'Database statistics not available'
                })
            
            return jsonify(stats_data)
            
        except Exception as e:
            return jsonify({
                'error': 'ƒ∞statistikler y√ºklenemedi',
                'message': str(e),
                'api_version': '2.0.0'
            }), 500
    
    # === DATABASE INITIALIZATION ===
    with app.app_context():
        try:
            db.create_all()
            print("‚úÖ Database tables created successfully")
        except Exception as e:
            print(f"‚ö†Ô∏è Database initialization error: {e}")
    
    # === LOGGING SETUP ===
    if not app.debug:
        import logging
        from logging.handlers import RotatingFileHandler
        
        if not os.path.exists('logs'):
            os.mkdir('logs')
        
        file_handler = RotatingFileHandler('logs/app_working.log', maxBytes=10240, backupCount=10)
        file_handler.setFormatter(logging.Formatter(
            '%(asctime)s %(levelname)s: %(message)s [in %(pathname)s:%(lineno)d]'
        ))
        file_handler.setLevel(logging.INFO)
        app.logger.addHandler(file_handler)
        app.logger.setLevel(logging.INFO)
    
    return app

# === APPLICATION CREATION ===
app = create_app()

if __name__ == '__main__':
    print("")
    print("üö® DEPLOYMENT READY:")
    print("‚Ä¢ Local Development: python app_working.py")
    print("‚Ä¢ Production Command: gunicorn app_working:app")
    print("")
    print("üöÄ ZamanY√∂net AI Enhanced API v2.0 ba≈ülatƒ±lƒ±yor...")
    print(f"üåç Environment: {'development' if app.debug else 'production'}")
    print(f"üîß Debug mode: {app.debug}")
    print("üìù AI Features: Recommendations, Medication Tracking, Activity Tracking, Task Management")
    print("üîó CORS: Flutter Web compatibility enabled")
    print("üîê JWT: Authentication ready")
    print("")
    
    app.run(debug=True, port=5001, host='0.0.0.0')
